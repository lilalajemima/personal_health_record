{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<style>
    .priority-badge {
        font-size: 0.75rem;
    }
    .category-badge {
        font-size: 0.7rem;
        background-color: #e9ecef;
        color: #495057;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h2>Welcome, {{ session.user.name }}</h2>
        <p class="text-muted">{{ current_date }}</p>
    </div>
    <div class="col-md-6 text-md-end">
        <a href="{{ url_for('export_health_summary') }}" class="btn btn-outline-primary">
            <i class="fas fa-file-pdf"></i> Export Health Summary
        </a>
    </div>
</div>

<div class="row">
    <!-- Health Overview -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Health Overview</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="health-stat-card">
                            <div class="stat-icon bg-primary">
                                <i class="fas fa-pills"></i>
                            </div>
                            <div class="stat-info">
                                <h3>{{ med_count }}</h3>
                                <p>Active Medications</p>
                                <a href="{{ url_for('medications_list') }}" class="btn btn-sm btn-outline-secondary">View All</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="health-stat-card">
                            <div class="stat-icon bg-success">
                                <i class="fas fa-syringe"></i>
                            </div>
                            <div class="stat-info">
                                <h3>{% if next_vaccine %}1{% else %}0{% endif %}</h3>
                                <p>Upcoming Vaccines</p>
                                <a href="{{ url_for('vaccines_list') }}" class="btn btn-sm btn-outline-secondary">View All</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Health Recommendations -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Recommended Health Tests</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshRecommendations()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="card-body" id="recommendations-container">
                {% if recommendations %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    These AI-generated suggestions are based on your profile 
                    (Age: {{ session.user.age or 'N/A' }}, 
                    Gender: {{ session.user.gender or 'N/A' }},
                    Weight: {{ session.user.weight or 'N/A' }} kg).
                    Always consult with your healthcare provider.
                </div>
                
                <div class="row">
                    {% for rec in recommendations %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6>{{ rec.name }}</h6>
                                    <span class="badge priority-badge bg-{% if rec.priority == 'high' %}danger{% elif rec.priority == 'medium' %}warning{% else %}info{% endif %}">
                                        {{ rec.priority|capitalize }}
                                    </span>
                                </div>
                                <p class="text-muted small mb-3">{{ rec.description }}</p>
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge category-badge me-2">
                                        {{ rec.category|replace('_', ' ')|title }}
                                    </span>
                                    <small class="text-primary">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        {{ rec.frequency }}
                                    </small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary w-100 mt-2" 
                                        onclick="addReminder('{{ rec.name }}')">
                                    <i class="fas fa-bell me-1"></i> Set Reminder
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-robot fa-2x text-muted mb-3"></i>
                    <p>No recommendations available</p>
                    <p class="text-muted small">
                        {% if not session.user.age or not session.user.gender %}
                            Complete your profile to get personalized health test suggestions
                            <a href="{{ url_for('profile') }}" class="btn btn-sm btn-primary mt-2">
                                <i class="fas fa-user-edit"></i> Update Profile
                            </a>
                        {% else %}
                            Could not generate recommendations at this time
                        {% endif %}
                    </p>
                </div>
                {% endif %}
                
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Disclaimer:</strong> AI-generated health recommendations should never replace professional 
                    medical advice. Always consult with your healthcare provider regarding any tests or treatments.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upcoming Reminders -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Upcoming Reminders</h5>
                <a href="{{ url_for('reminders_list') }}" class="btn btn-sm btn-outline-secondary">View All</a>
            </div>
            <div class="card-body p-0">
                {% if reminders %}
                <ul class="list-group list-group-flush">
                    {% for reminder in reminders %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="mb-1">{{ reminder.title }}</h6>
                                <small class="text-muted">{{ reminder.due_date|datetimeformat }}</small>
                            </div>
                            {% if reminder.type == 'medication' %}
                            <span class="badge bg-info">Medication</span>
                            {% elif reminder.type == 'vaccine' %}
                            <span class="badge bg-success">Vaccine</span>
                            {% else %}
                            <span class="badge bg-secondary">General</span>
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="p-3 text-center text-muted">
                    No upcoming reminders
                </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addReminderModal">
                    <i class="fas fa-plus"></i> Add Reminder
                </button>
            </div>
        </div>
        
        <!-- Recent Lab Report -->
        {% if recent_lab %}
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Recent Lab Report</h5>
            </div>
            <div class="card-body">
                <h6>{{ recent_lab.name }}</h6>
                <p class="text-muted">{{ recent_lab.test_type }}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <small>{{ recent_lab.date|datetimeformat }}</small>
                    <a href="{{ url_for('download_lab_report', report_id=recent_lab._id) }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download"></i> Download
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Reminder Modal -->
<div class="modal fade" id="addReminderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('reminders_create') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-control" name="due_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                    <input type="hidden" name="type" value="general">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Reminder</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function refreshRecommendations() {
    const container = document.getElementById('recommendations-container');
    
    
    container.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Generating new recommendations...</p>
        </div>
    `;
    
    
    fetch('{{ url_for("api_health_recommendations") }}')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                
                window.location.reload();
            } else {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        ${data.error || 'Could not generate recommendations'}
                    </div>
                    <div class="text-center">
                        <button onclick="window.location.reload()" class="btn btn-primary">
                            <i class="fas fa-undo"></i> Try Again
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error: ${error.message || 'Failed to fetch recommendations'}
                </div>
                <div class="text-center">
                    <button onclick="window.location.reload()" class="btn btn-primary">
                        <i class="fas fa-undo"></i> Try Again
                    </button>
                </div>
            `;
        });
}

function addReminder(testName) {
    const modal = new bootstrap.Modal(document.getElementById('addReminderModal'));
    const titleInput = document.querySelector('#addReminderModal input[name="title"]');
    const notesInput = document.querySelector('#addReminderModal textarea[name="notes"]');
    
    titleInput.value = `Schedule ${testName} test`;
    notesInput.value = `Recommended health test: ${testName}\n\nConsult with your doctor about this test.`;
    
    const futureDate = new Date();
    futureDate.setMonth(futureDate.getMonth() + 6);
    const dateStr = futureDate.toISOString().split('T')[0];
    document.querySelector('#addReminderModal input[name="due_date"]').value = dateStr;
    
    modal.show();
}
</script>
{% endblock %}